{% load static %}
<div class="">
  <div class="card">
    <div class="card-body">
      {% csrf_token %}

      <input type="hidden" name="rebalancing_run_user" value="" />
      <div class="row">
        <div class="col-lg-3">
          <div class="p-2 rounded-2 bg-branding mt-2 mb-3">Parameters</div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-3">
          <div>
            <label class="form-label">Total # of Companies</label>
          </div>
          <div>
            <input type="number" class="form-control p-2" name="total_companies" id="" value="0.00" />
          </div>
        </div>
        <div class="col-lg-3">
          <div>
            <label class="form-label">Sector Restriction</label>
          </div>
          <div class="row">
            <div class="col-lg-6">
              <input type="number" class="form-control p-2" name="sector_min" id="" placeholder="Min. Value" />
            </div>
            <div class="col-lg-6">
              <input type="number" class="form-control p-2" name="sector_max" id="" placeholder="Max. Value" />
            </div>
          </div>
        </div>
        <div class="col-lg-3">
          <div>
            <label class="form-label">Total # of Companies in Portfolio</label>
          </div>
          <div>
            <input type="number" class="form-control p-2" name="total_portfolios_in_companies" id="" value="0.00" />
          </div>
        </div>
      </div>
      <div class="row mt-4 mb-3">
        <div class="col-lg-4">
          <div class="p-2 rounded-2 bg-branding">Distribution Parameters</div>
        </div>
        <div class="col-lg-8">
          <div style="max-width: 230px">
            <label class="form-label">Metric <small>(You can select maximum 5 metrics)</small></label>
            <div>
              <select class="form-control p-2" name="" id="metric-input" multiple="multiple">
                <option value="Marketcap">Marketcap</option>
                <option value="Beta">Beta</option>
                <option value="Volatility">Volatility</option>
                <option value="PE">PE</option>
                <option value="Rev_Growth">RevGrowth</option>
                <option value="Dividend_Yield">Dividend Yield</option>
                <option value="EPS">EPS</option>
                <option value="Profit_Margin">Profit Margin</option>
                <option value="ROE">ROE</option>
                <option value="Debt_To_Equity">Debt To Equity</option>
                <option value="Operating_Cash_Flow">Operating Cash Flow</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-4" id="sector-industry-container">
          <div class="row">
            <div class="col-lg-6">
              <div id="sector-dropdown" class="dropdown d-flex justify-content-center">
                <button class="dropdown-button form-label">Select Sector</button>
                <div class="dropdown-content">
                  <label> <input type="checkbox" id="select-all-sectors" /> Select All </label>
                  <label> <input type="checkbox" class="sector-option" value="Technology" /> Technology </label>
                  <label> <input type="checkbox" class="sector-option" value="Communication Services" /> Communication Services </label>
                  <label> <input type="checkbox" class="sector-option" value="Consumer Cyclical" /> Consumer Cyclical </label>
                  <label> <input type="checkbox" class="sector-option" value="Consumer Defensive" /> Consumer Defensive </label>
                  <label> <input type="checkbox" class="sector-option" value="Financial Services" /> Financial Services </label>
                </div>
              </div>
              <div class="container-chart mt-4">
                <canvas id="sectorChart"></canvas>
                <h3 class="mt-4">0 of Companies</h3>
              </div>
              <div class="container-chart mt-4">
                <label for=""> <input type="checkbox" name="" id="" />Total # of permutations </label>
              </div>
            </div>
            <div class="col-lg-6">
              <div id="industry-dropdown" class="dropdown d-flex justify-content-center">
                <button class="dropdown-button">Select Industry</button>
                <div class="dropdown-content">
                  <label> <input type="checkbox" id="select-all-industries" /> Select All </label>
                  <label> <input type="checkbox" class="industry-option" value="Consumer Electronics" /> Consumer Electronics </label>
                  <label> <input type="checkbox" class="industry-option" value="Software - Infrastructure" /> Software - Infrastructure </label>
                  <label> <input type="checkbox" class="industry-option" value="Semiconductors" /> Semiconductors </label>
                  <label> <input type="checkbox" class="industry-option" value="Internet Content & Information" /> Internet Content & Information </label>
                  <label> <input type="checkbox" class="industry-option" value="Internet Retail" /> Internet Retail </label>
                  <label> <input type="checkbox" class="industry-option" value="Auto Manufacturers" /> Auto Manufacturers </label>
                  <label> <input type="checkbox" class="industry-option" value="Discount Stores" /> Discount Stores </label>
                  <label> <input type="checkbox" class="industry-option" value="Banks - Diversified" /> Banks - Diversified </label>
                  <label> <input type="checkbox" class="industry-option" value="Credit Services" /> Credit Services </label>
                </div>
              </div>
              <div class="container-chart mt-4">
                <canvas id="industryChart"></canvas>
                <h3 class="mt-4">0 of Companies</h3>
              </div>
              <div class="container-chart mt-4">
                <label for=""> <input type="checkbox" name="" id="" />Total # of permutations </label>
              </div>
            </div>
          </div>
          <div class="divider-line"></div>
        </div>

        <div class="col-lg-8">
          <div id="p1-metric-row"></div>
          <div class="row">
            <div id="metric-row" class="container-chart-market">
              <div>
                <label for="marketcap-1">Marketcap</label>
                <select id="marketcap" class="form-control">
                  <option value="Select_All">Select all</option>
                  <option value="0 - 50 Billion">0 - 50 Billion</option>
                  <option value="50 - 100 Billion">50 - 100 Billion</option>
                  <option value="100 Billion and above">100 Billion and above</option>
                </select>
                <div class="container-chart mt-4">
                  <img src="{% static 'images/demo-pie.png' %}" alt="" />

                  <h3 class="mt-4">0 of Companies</h3>
                </div>
                <div class="container-chart mt-4">
                  <label for=""> <input type="checkbox" name="" id="" />Include Marketcap </label>
                </div>
              </div>

              <div>
                <label for="beta">Beta</label>
                <select id="beta" class="form-control">
                  <option value="Select_All">Select all</option>
                  <option value="0 - 1">0 - 1</option>
                  <option value="1 - 2">1 - 2</option>
                  <option value="2 - 3">2 - 3</option>
                </select>
                <div class="container-chart mt-4">
                  <img src="{% static 'images/demo-pie.png' %}" alt="" />

                  <h3 class="mt-4">0 of Companies</h3>
                </div>
                <div class="container-chart mt-4">
                  <label for=""> <input type="checkbox" name="" id="" />Include Beta </label>
                </div>
              </div>

              <div>
                <label for="volatility">Volatilitiy</label>
                <select id="volatility" class="form-control">
                  <option value="Select_All">Select all</option>
                  <option value="0 - 0.5">0 - 0.5</option>
                  <option value="0.5 - 1">0.5 - 1</option>
                  <option value="1 and above">1 and above</option>
                </select>
                <div class="container-chart mt-4">
                  <img src="{% static 'images/demo-pie.png' %}" alt="" />
                  <div id="volatilityChart"></div>
                  <h3 class="mt-4">0 of Companies</h3>
                </div>
                <div class="container-chart mt-4">
                  <label for=""> <input type="checkbox" name="" id="" />Include Volatilitiy </label>
                </div>
              </div>

              <div>
                <label for="pe">PE</label>
                <select id="pe" class="form-control">
                  <option value="Select_All">Select all</option>
                  <option value="0 - 15">0 - 15</option>
                  <option value="15 - 30">15 - 30</option>
                  <option value="30 and above">30 and above</option>
                </select>
                <div class="container-chart mt-4">
                  <img src="{% static 'images/demo-pie.png' %}" alt="" />
                  <h3 class="mt-4">0 of Companies</h3>
                </div>
                <div class="container-chart mt-4">
                  <label for=""> <input type="checkbox" name="" id="" />Include PE </label>
                </div>
              </div>

              <div>
                <label for="rev_growth">Rev Growth</label>
                <select id="rev_growth" class="form-control">
                  <option value="Select_All">Select all</option>
                  <option value="0 - 5%">0 - 5%</option>
                  <option value="5 - 10%">5 - 10%</option>
                  <option value="10% and above">10% and above</option>
                </select>
                <div class="container-chart mt-4">
                  <img src="{% static 'images/demo-pie.png' %}" alt="" />
                  <h3 class="mt-4">0 of Companies</h3>
                </div>
                <div class="container-chart mt-4">
                  <label for=""> <input type="checkbox" name="" id="" />Include Rev Growth </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="submit-btn-container">
        <button type="submit" class="btn bg-branding">Process</button>
      </div>
    </div>
  </div>
</div>

<script>
  const data = [
    { id: 1, Sector: 'Technology', Industry: 'Consumer Electronics', Marketcap: 3448289886208 },
    { id: 2, Sector: 'Technology', Industry: 'Software - Infrastructure', Marketcap: 3092590624768 },
    { id: 3, Sector: 'Technology', Industry: 'Semiconductors', Marketcap: 3064287461376 },
    { id: 4, Sector: 'Communication Services', Industry: 'Internet Content & Information', Marketcap: 2064893739008 },
    { id: 5, Sector: 'Consumer Cyclical', Industry: 'Internet Retail', Marketcap: 1957534236672 },
    { id: 6, Sector: 'Communication Services', Industry: 'Internet Content & Information', Marketcap: 1507620814848 },
    { id: 7, Sector: 'Consumer Cyclical', Industry: 'Auto Manufacturers', Marketcap: 798915559424 },
    { id: 8, Sector: 'Consumer Defensive', Industry: 'Discount Stores', Marketcap: 650615980032 },
    { id: 9, Sector: 'Financial Services', Industry: 'Banks - Diversified', Marketcap: 600954699776 },
    { id: 10, Sector: 'Financial Services', Industry: 'Credit Services', Marketcap: 540818440192 },
  ];

  const sectorDropdown = document.getElementById('sector-dropdown');
  const industryDropdown = document.getElementById('industry-dropdown');
  const selectAllSectors = document.getElementById('select-all-sectors');
  const selectAllIndustries = document.getElementById('select-all-industries');
  const sectorOptions = document.querySelectorAll('.sector-option');
  const industryOptions = document.querySelectorAll('.industry-option');
  const sectorChartCanvas = document.getElementById('sectorChart');
  const industryChartCanvas = document.getElementById('industryChart');
  let sectorChart, industryChart;

  sectorDropdown.querySelector('.dropdown-button').addEventListener('click', () => {
    sectorDropdown.classList.toggle('open');
  });

  industryDropdown.querySelector('.dropdown-button').addEventListener('click', () => {
    industryDropdown.classList.toggle('open');
  });

  document.addEventListener('click', (e) => {
    if (!sectorDropdown.contains(e.target)) {
      sectorDropdown.classList.remove('open');
    }
    if (!industryDropdown.contains(e.target)) {
      industryDropdown.classList.remove('open');
    }
  });

  selectAllSectors.addEventListener('change', () => {
    sectorOptions.forEach((option) => (option.checked = selectAllSectors.checked));
    updateCharts();
  });

  selectAllIndustries.addEventListener('change', () => {
    industryOptions.forEach((option) => (option.checked = selectAllIndustries.checked));
    updateCharts();
  });

  function updateSectorChart() {
    const selectedSectors = [...sectorOptions].filter((option) => option.checked).map((option) => option.value);
    const filteredData = data.filter((d) => selectedSectors.includes(d.Sector));

    const sectorAggregates = filteredData.reduce((acc, curr) => {
      acc[curr.Sector] = (acc[curr.Sector] || 0) + 1;
      return acc;
    }, {});

    const chartLabels = Object.keys(sectorAggregates);
    const chartValues = Object.values(sectorAggregates);

    if (sectorChart) sectorChart.destroy();
    sectorChart = new Chart(sectorChartCanvas, {
      type: 'doughnut',
      data: {
        labels: chartLabels,
        datasets: [
          {
            data: chartValues,
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: false, // Menyembunyikan label
          },
        },
      },
    });
  }

  function updateIndustryChart() {
    const selectedIndustries = [...industryOptions].filter((option) => option.checked).map((option) => option.value);
    const filteredData = data.filter((d) => selectedIndustries.includes(d.Industry));

    const industryAggregates = filteredData.reduce((acc, curr) => {
      acc[curr.Industry] = (acc[curr.Industry] || 0) + 1;
      return acc;
    }, {});

    const chartLabels = Object.keys(industryAggregates);
    const chartValues = Object.values(industryAggregates);

    if (industryChart) industryChart.destroy();
    industryChart = new Chart(industryChartCanvas, {
      type: 'doughnut',
      data: {
        labels: chartLabels,
        datasets: [
          {
            data: chartValues,
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: false, // Menyembunyikan label
          },
        },
      },
    });
  }

  function updateCharts() {
    updateSectorChart();
    updateIndustryChart();
  }
</script>

